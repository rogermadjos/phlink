import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.awt.image.BufferedImage;
import java.util.logging.Level;
import java.util.logging.Logger;

import com.google.zxing.BinaryBitmap;
import com.google.zxing.ReaderException;
import com.google.zxing.Result;
import com.google.zxing.client.j2se.BufferedImageLuminanceSource;
import com.google.zxing.common.HybridBinarizer;
import com.google.zxing.qrcode.QRCodeReader;

public class QRDecoder {
	private final Logger logger = Logger.getLogger(QRDecoder.class.getName());
	private ActionListener listener;
	private String data = "";
	
	public QRDecoder(ActionListener listener) {
		this.listener = listener;
	}
	
	public String getData() {
		return data;
	}
	
    public void decodeQRCode(BufferedImage image) {
    	BinaryBitmap binaryBitmap = new BinaryBitmap(new HybridBinarizer(new BufferedImageLuminanceSource(image)));
    	QRCodeReader reader = new QRCodeReader();
    	
    	Result result;
    	try {
			result = reader.decode(binaryBitmap);
			String newData = result.getText();
			if(!newData.equals(data)) {
				data = newData;
				listener.actionPerformed(new ActionEvent(this, 0, "QR_CODE"));
			}
    		logger.log(Level.INFO, newData + ":" + data);
		} catch (ReaderException e) {
//			logger.log(Level.INFO, "No QR code", e);
		}
    }
}
